
jQuery.Class("OpenStreetMap_Map_Js",{},{container:false,mapInstance:false,selectedParams:false,layerMarkers:false,markers:false,polygonLayer:false,routeLayer:false,setSelectedParams:function(a){this.selectedParams=a},registerMap:function(c,a){var b=L.map("mapid").setView(c,a);L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(b);this.mapInstance=b;return b},setMarkersByResponse:function(e){var j=[];var m=e.result.coordinates;var c=this.container;var b=this.mapInstance;var f=L.markerClusterGroup({maxClusterRadius:10});b.removeLayer(this.layerMarkers);m.forEach(function(o){j.push([o.lat,o.lon]);var n=L.marker([o.lat,o.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:o.color})}).bindPopup(o.label);f.addLayer(n)});b.removeLayer(this.polygonLayer);if(typeof e.result.coordinatesCeneter!="undefined"){if(typeof e.result.coordinatesCeneter.error=="undefined"){var i=c.find(".radius").val();j.push([e.result.coordinatesCeneter.lat,e.result.coordinatesCeneter.lon]);var g=L.marker([e.result.coordinatesCeneter.lat,e.result.coordinatesCeneter.lon],{icon:L.AwesomeMarkers.icon({icon:"search",markerColor:"red",prefix:"fa",})});f.addLayer(g);if($.isNumeric(i)){i=parseInt(i)*1000;var a=L.circle([e.result.coordinatesCeneter.lat,e.result.coordinatesCeneter.lon],i,{color:"red",fillColor:"#f03",fillOpacity:0.05});this.polygonLayer=L.featureGroup([a]);b.addLayer(this.polygonLayer)}}else{var d={title:app.vtranslate("JS_LBL_PERMISSION"),text:e.result.coordinatesCeneter.error,type:"error",animation:"show"};Vtiger_Helper_Js.showMessage(d)}}this.markers=m;this.layerMarkers=f;b.addLayer(f);var l=this.container.find(".modal-footer");if(typeof e.result.legend!="undefined"){var h="";var k=e.result.legend;k.forEach(function(n){h+='<div class="pull-left"><span class="leegendIcon" style="background:'+n.color+'"></span> '+n.value+"</div>"});l.html(h)}else{l.html("")}if(j.length){b.fitBounds(j)}this.container.find(".groupNeighbours").prop("checked",true)},registerBasicModal:function(){var d=this;var a=this.container;var e=d.mapInstance;a.find(".groupBy").on("click",function(){var f=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var g={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),groupBy:a.find(".fieldsToGroup").val(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val()};$.extend(g,d.selectedParams);AppConnector.request(g).then(function(h){f.progressIndicator({mode:"hide"});d.setMarkersByResponse(h)})});a.find(".groupNeighbours").on("change",function(i){var h=$(i.currentTarget);e.removeLayer(d.layerMarkers);var j=d.markers;if(h.is(":checked")){var f=L.markerClusterGroup({maxClusterRadius:10});j.forEach(function(l){var k=L.marker([l.lat,l.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:l.color})}).bindPopup(l.label);f.addLayer(k)})}else{var g=[];j.forEach(function(l){var k=L.marker([l.lat,l.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:l.color})}).bindPopup(l.label);g.push(k)});var f=L.featureGroup(g)}d.layerMarkers=f;e.addLayer(f)});a.find(".searchBtn").on("click",function(g){var f=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var h={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val()};$.extend(h,d.selectedParams);AppConnector.request(h).then(function(i){f.progressIndicator({mode:"hide"});d.setMarkersByResponse(i)})});var b=false;a.on("click",".startTrack",function(k){e.removeLayer(b);var j=$(k.currentTarget);var g=j.closest(".leaflet-popup-content");var i=g.find(".description").html();var h=a.find(".start");var l=g.find(".coordinates");var i=i.replace(/\<br\>/gi,", ");h.val(i);h.data("lat",l.data("lat"));h.data("lon",l.data("lon"));var f=L.marker([l.data("lat"),l.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"truck",markerColor:"green",prefix:"fa",})}).bindPopup(g.html());b=L.featureGroup([f]);e.addLayer(b)});var c=false;a.on("click",".endTrack",function(k){e.removeLayer(c);var j=$(k.currentTarget);var g=j.closest(".leaflet-popup-content");var i=g.find(".description").html();var h=a.find(".end");var l=g.find(".coordinates");var i=i.replace(/\<br\>/gi,", ");h.val(i);h.data("lat",l.data("lat"));h.data("lon",l.data("lon"));var f=L.marker([l.data("lat"),l.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"flag-checkered",markerColor:"red",prefix:"fa",})}).bindPopup(g.html());c=L.featureGroup([f]);e.addLayer(c)});a.find(".calculateTrack").on("click",function(){var f=a.find(".end");var g=a.find(".start");var h=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var i={url:"index.php",data:{module:"OpenStreetMap",action:"GetRoute",flon:g.data("lon"),flat:g.data("lat"),tlon:f.data("lon"),tlat:f.data("lat")},dataType:"html"};AppConnector.request(i).then(function(k){h.progressIndicator({mode:"hide"});e.removeLayer(d.routeLayer);var k=JSON.parse(k);var j=L.geoJson(k);d.routeLayer=L.featureGroup([j]);e.addLayer(d.routeLayer);a.find(".descriptionContainer").removeClass("hide");a.find(".descriptionContent .instruction").html(k.properties.description);a.find(".descriptionContent .distance").html(app.parseNumberToShow(k.properties.distance));a.find(".descriptionContent .travelTime").html(app.parseNumberToShow(k.properties.traveltime/60))})})},registerModalView:function(a){var c=this;var d=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});this.container=a;var f=[0,0];var b=2;$("#mapid").css({height:500});this.registerMap(f,b);var e={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),};$.extend(e,this.selectedParams);AppConnector.request(e).then(function(g){d.progressIndicator({mode:"hide"});c.setMarkersByResponse(g);c.registerBasicModal()})},registerDetailView:function(a){this.container=a;var f=a.find("#coordinates").val();f=JSON.parse(f);var h=[0,0];var b=2;if(f.length){h=f[0];b=6}var g=$("#mapid").position();var c=$(".footerContainer ").position();$("#mapid").css({height:c.top-g.top-281});var e=this.registerMap(h,b);var d=L.markerClusterGroup({maxClusterRadius:10});f.forEach(function(j){var i=L.marker([j.lat,j.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:j.color})}).bindPopup(j.label);d.addLayer(i)});e.addLayer(d)}});