
jQuery.Class("OpenStreetMap_Map_Js",{},{container:false,mapInstance:false,selectedParams:false,layerMarkers:false,markers:false,polygonLayer:false,setSelectedParams:function(a){this.selectedParams=a},registerMap:function(c,a){var b=L.map("mapid").setView(c,a);L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(b);this.mapInstance=b;return b},setMarkersByResponse:function(e){var j=[];var m=e.result.coordinates;var c=this.container;var b=this.mapInstance;var f=L.markerClusterGroup({maxClusterRadius:10});b.removeLayer(this.layerMarkers);m.forEach(function(o){j.push([o.lat,o.lon]);var n=L.marker([o.lat,o.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:o.color})}).bindPopup(o.label);f.addLayer(n)});b.removeLayer(this.polygonLayer);if(typeof e.result.coordinatesCeneter!="undefined"){if(typeof e.result.coordinatesCeneter.error=="undefined"){var i=c.find(".radius").val();j.push([e.result.coordinatesCeneter.lat,e.result.coordinatesCeneter.lon]);var g=L.marker([e.result.coordinatesCeneter.lat,e.result.coordinatesCeneter.lon],{icon:L.AwesomeMarkers.icon({icon:"search",markerColor:"red",prefix:"fa",})});f.addLayer(g);if($.isNumeric(i)){i=parseInt(i)*1000;var a=L.circle([e.result.coordinatesCeneter.lat,e.result.coordinatesCeneter.lon],i,{color:"red",fillColor:"#f03",fillOpacity:0.3});this.polygonLayer=L.featureGroup([a]);b.addLayer(this.polygonLayer)}}else{var d={title:app.vtranslate("JS_LBL_PERMISSION"),text:e.result.coordinatesCeneter.error,type:"error",animation:"show"};Vtiger_Helper_Js.showMessage(d)}}this.markers=m;this.layerMarkers=f;b.addLayer(f);var l=this.container.find(".modal-footer");if(typeof e.result.legend!="undefined"){var h="";var k=e.result.legend;k.forEach(function(n){h+='<div class="pull-left"><span class="leegendIcon" style="background:'+n.color+'"></span> '+n.value+"</div>"});l.html(h)}else{l.html("")}if(j.length){b.fitBounds(j)}this.container.find(".groupNeighbours").prop("checked",true)},registerBasicModal:function(){var b=this;var a=this.container;a.find(".groupBy").on("click",function(){var c=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var d={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),groupBy:a.find(".fieldsToGroup").val(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val()};$.extend(d,b.selectedParams);AppConnector.request(d).then(function(e){c.progressIndicator({mode:"hide"});b.setMarkersByResponse(e)})});a.find(".groupNeighbours").on("change",function(h){var g=$(h.currentTarget);var f=b.mapInstance;f.removeLayer(b.layerMarkers);var i=b.markers;if(g.is(":checked")){var c=L.markerClusterGroup({maxClusterRadius:10});i.forEach(function(k){var j=L.marker([k.lat,k.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:k.color})}).bindPopup(k.label);c.addLayer(j)})}else{var d=[];i.forEach(function(k){var j=L.marker([k.lat,k.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:k.color})}).bindPopup(k.label);d.push(j)});var c=L.featureGroup(d)}b.layerMarkers=c;f.addLayer(c)});a.find(".searchBtn").on("click",function(d){var c=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var f={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val()};$.extend(f,b.selectedParams);AppConnector.request(f).then(function(e){c.progressIndicator({mode:"hide"});b.setMarkersByResponse(e)})})},registerModalView:function(a){var c=this;app.showBtnSwitch(a.find(".switchBtn"));var d=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});this.container=a;var f=[0,0];var b=2;$("#mapid").css({height:500});this.registerMap(f,b);var e={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),};$.extend(e,this.selectedParams);AppConnector.request(e).then(function(g){d.progressIndicator({mode:"hide"});c.setMarkersByResponse(g);c.registerBasicModal()})},registerDetailView:function(a){this.container=a;var f=a.find("#coordinates").val();f=JSON.parse(f);var h=[0,0];var b=2;if(f.length){h=f[0];b=6}var g=$("#mapid").position();var c=$(".footerContainer ").position();$("#mapid").css({height:c.top-g.top-281});var e=this.registerMap(h,b);var d=L.markerClusterGroup({maxClusterRadius:10});f.forEach(function(j){var i=L.marker([j.lat,j.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:j.color})}).bindPopup(j.label);d.addLayer(i)});e.addLayer(d)}});