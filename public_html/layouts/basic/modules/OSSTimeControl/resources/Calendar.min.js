jQuery.Class("OSSTimeControl_Calendar_Js",{registerUserListWidget:function(){var a=$(".widgetContainer");a.hover(function(){$(this).css("overflow","visible")},function(){$(this).css("overflow","hidden")});this.registerColorField(a.find("#calendarUserList"),"userCol");this.registerColorField(a.find("#timecontrolTypes"),"listCol");a.find(".select2").on("change",function(){$(this).closest(".siteBarContent").find(".refreshHeader").removeClass("d-none")})},registerColorField:function(b,a){var c={};c.dropdownCss={"z-index":0};c.formatSelection=function(f,d){var e=f.id;var h=b.find('option[value="'+e+'"]');d.addClass(a+"_"+e);var g="<div>"+h.text()+"</div>";return g};app.changeSelectElementView(b,"select2",c)}},{calendarView:false,calendarCreateView:false,registerCalendar:function(){var h=this;var i=jQuery("#eventLimit").val();if(i=="true"){i=true}else{if(i=="false"){i=false}else{i=parseInt(i)+1}}var b=jQuery("#weekView").val();var f=jQuery("#dayView").val();var a=jQuery("#activity_view").val();if(a=="Today"){a=f}else{if(a=="This Week"){a=b}else{a="month"}}var e=jQuery("#time_format").val();var c;if(e==24){e="H:mm";c="HH:mm"}else{e="h:mmt";c="hh:mm A"}var g=CONFIG.firstDayOfWeekNo;var d=jQuery("#start_hour").val();var j=d.split(":");d=j["0"];h.getCalendarView().fullCalendar({header:{left:"month,"+b+","+f,center:"title today",right:"prev,next"},timeFormat:e,axisFormat:e,firstHour:d,firstDay:g,defaultView:a,editable:true,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:true,defaultTimedEventDuration:"01:00:00",eventLimit:i,allDaySlot:false,height:($(window).width()>993)?($(window).height()-135):"auto",views:{basic:{eventLimit:false}},dayClick:function(m,l,k){h.selectDay(m.format());h.getCalendarView().fullCalendar("unselect")},eventDrop:function(l,m,k){h.updateEvent(l,m,k)},eventResize:function(l,m,k){h.updateEvent(l,m,k)},eventRender:function(l,k){app.showPopoverElementView(k.find(".fc-content"),{title:l.title+'<a href="index.php?module=OSSTimeControl&view=Edit&record='+l.id+'" class="btn btn-default btn-xs pull-right"><span class="fas fa-edit"></span></a><a href="index.php?module=OSSTimeControl&view=Detail&record='+l.id+'" class="btn btn-default btn-xs pull-right"><span class="fas fa-th-list"></span></a>',container:"body",html:true,placement:"auto",template:'<div class="popover calendarPopover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',content:'<div><span class="far fa-clock"></span> <label>'+app.vtranslate("JS_START_DATE")+"</label>: "+l.start.format("YYYY-MM-DD "+c)+'</div><div><span class="far fa-clock"></span> <label>'+app.vtranslate("JS_END_DATE")+"</label>: "+l.end.format("YYYY-MM-DD "+c)+'</div><div><span class="far fa-clock"></span> <label>'+app.vtranslate("JS_TOTAL_TIME")+"</label>: "+l.totalTime+'</div><div><span class="fas fa-bars"></span> <label>'+app.vtranslate("JS_NUMBER")+"</label>: "+l.number+'</div><div><span class="fas fa-question-circle"></span> <label>'+app.vtranslate("JS_TYPE")+"</label>: "+l.type+"</div>"+(l.status?'<div><span class="far fa-star"></span> <label>'+app.vtranslate("JS_STATUS")+"</label>: "+l.status+"</div>":"")+(l.linkl?'<div><span class="userIcon-'+l.linkm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_RELATION")+'</label>: <a target="_blank" href="index.php?module='+l.linkm+"&view=Detail&record="+l.link+'">'+l.linkl+"</a></div>":"")+(l.linkexl?'<div><span class="userIcon-'+l.linkexm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_RELATION_EXTEND")+'</label>: <a target="_blank" href="index.php?module='+l.linkexm+"&view=Detail&record="+l.linkextend+'">'+l.linkexl+"</a></div>":"")+(l.procl?'<div><span class="userIcon-'+l.procm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_PROCESS")+'</label>: <a target="_blank" href="index.php?module='+l.procm+"&view=Detail&record="+l.process+'">'+l.procl+"</a></div>":"")+(l.subprocl?'<div><span class="userIcon-'+l.subprocm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_SUB_PROCESS")+'</label>: <a target="_blank" href="index.php?module='+l.subprocm+"&view=Detail&record="+l.subprocess+'">'+l.subprocl+"</a></div>":"")+(l.smownerid?'<div><span class="fas fa-user"></span> <label>'+app.vtranslate("JS_ASSIGNED_TO")+"</label>: "+l.smownerid+"</div>":"")})},monthNames:[app.vtranslate("JS_JANUARY"),app.vtranslate("JS_FEBRUARY"),app.vtranslate("JS_MARCH"),app.vtranslate("JS_APRIL"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUNE"),app.vtranslate("JS_JULY"),app.vtranslate("JS_AUGUST"),app.vtranslate("JS_SEPTEMBER"),app.vtranslate("JS_OCTOBER"),app.vtranslate("JS_NOVEMBER"),app.vtranslate("JS_DECEMBER")],monthNamesShort:[app.vtranslate("JS_JAN"),app.vtranslate("JS_FEB"),app.vtranslate("JS_MAR"),app.vtranslate("JS_APR"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUN"),app.vtranslate("JS_JUL"),app.vtranslate("JS_AUG"),app.vtranslate("JS_SEP"),app.vtranslate("JS_OCT"),app.vtranslate("JS_NOV"),app.vtranslate("JS_DEC")],dayNames:[app.vtranslate("JS_SUNDAY"),app.vtranslate("JS_MONDAY"),app.vtranslate("JS_TUESDAY"),app.vtranslate("JS_WEDNESDAY"),app.vtranslate("JS_THURSDAY"),app.vtranslate("JS_FRIDAY"),app.vtranslate("JS_SATURDAY")],dayNamesShort:[app.vtranslate("JS_SUN"),app.vtranslate("JS_MON"),app.vtranslate("JS_TUE"),app.vtranslate("JS_WED"),app.vtranslate("JS_THU"),app.vtranslate("JS_FRI"),app.vtranslate("JS_SAT")],buttonText:{today:app.vtranslate("JS_TODAY"),month:app.vtranslate("JS_MONTH"),week:app.vtranslate("JS_WEEK"),day:app.vtranslate("JS_DAY")},allDayText:app.vtranslate("JS_ALL_DAY"),eventLimitText:app.vtranslate("JS_MORE")})},registerRefreshEvent:function(){var a=this;$(".refreshCalendar").click(function(){$(this).closest(".refreshHeader").addClass("d-none");a.loadCalendarData()})},registerButtonSelectAll:function(){var a=$(".selectAllBtn");a.click(function(d){var c=$(this).find(".selectAll");var b=$(this).find(".deselectAll");if(c.hasClass("d-none")){c.removeClass("d-none");b.addClass("d-none");$(this).closest(".quickWidget").find("select option").prop("selected",false)}else{$(this).closest(".quickWidget").find("select option").prop("selected",true);b.removeClass("d-none");c.addClass("d-none")}$(this).closest(".quickWidget").find("select").trigger("change")})},loadCalendarData:function(c){var a=jQuery.progressIndicator();var i=this;i.getCalendarView().fullCalendar("removeEvents");var h=i.getCalendarView().fullCalendar("getView");var f=h.start.format();var b=h.end.format();var e;if(jQuery("#calendarUserList").length==0){e=CONFIG.userId}else{e=jQuery("#calendarUserList").val()}if(jQuery("#timecontrolTypes").length>0){var g=jQuery("#timecontrolTypes").val()}else{c=true}if(c==true||g!=null){var d={module:"OSSTimeControl",action:"Calendar",mode:"getEvent",start:f,end:b,user:e,types:g};AppConnector.request(d).then(function(j){i.getCalendarView().fullCalendar("addEventSource",j.result);a.hide()})}else{i.getCalendarView().fullCalendar("removeEvents");a.hide()}},updateEvent:function(c,g,b){var d=jQuery.progressIndicator();var f=c.start.format();var a=c.end.format();var e={module:"OSSTimeControl",action:"Calendar",mode:"updateEvent",id:c.id,start:f,delta:g._data};AppConnector.request(e).then(function(h){if(!h.result){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));b()}d.hide()},function(h){d.hide();Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));b()})},selectDay:function(a){var b=this;b.getCalendarCreateView().then(function(j){if(j.length<=0){return}var c=j.find('[name="date_start"]').data("dateFormat").toUpperCase();var g=j.find('[name="time_start"]').data("format");if(g==24){var m="HH:mm"}else{m="hh:mm A"}var o=Date.parse(a);var r=moment(a).format(c);var e=moment(a).format(m);var f=Date.parse(a);var k=moment(a).format(c);var p=b.getCalendarView().fullCalendar("getView");if("month"==p.name){var l=parseInt((f-o)/(1000*60*60*24));var q;if(l>1){var i=jQuery("#start_hour").val();var s=i.split(":");e=s["0"];var h=jQuery("#end_hour").val();s=h.split(":");q=s["0"]}else{var d=new Date();e=moment(d).format(m);q=moment(d).add(15,"minutes").format(m)}}else{q=moment(f).add(30,"minutes").format(m)}j.find('[name="date_start"]').val(r);j.find('[name="due_date"]').val(k);j.find('[name="time_start"]').val(e);j.find('[name="time_end"]').val(q);var n=new Vtiger_Header_Js();n.handleQuickCreateData(j,{callbackFunction:function(t){b.addCalendarEvent(t.result,c)}});jQuery(".modal-body").css({"max-height":app.getScreenHeight(70)+"px","overflow-y":"auto"})})},addCalendarEvent:function(d,b){if($.inArray(d.assigned_user_id.value,$("#calendarUserList").val())<0){return}if($.inArray(d.timecontrol_type.value,$("#timecontrolTypes").val())<0){return}var f=this.getCalendarView();var a=f.fullCalendar("moment",d.date_start.value+" "+d.time_start.value);var e=f.fullCalendar("moment",d.due_date.value+" "+d.time_end.value);var c={id:d._recordId,title:d.name.display_value,start:a.toString(),end:e.toString(),url:"index.php?module=OSSTimeControl&view=Detail&record="+d._recordId,className:"ownerCBg_"+d.assigned_user_id.value+" picklistCBg_OSSTimeControl_timecontrol_type_"+d.timecontrol_type.value,title:d.name.display_value,totalTime:d.sum_time.display_value,number:d.osstimecontrol_no.display_value,type:d.timecontrol_type.display_value,status:d.osstimecontrol_status.display_value,smownerid:d.assigned_user_id.display_value};this.getCalendarView().fullCalendar("renderEvent",c)},getCalendarCreateView:function(){var b=this;var a=jQuery.Deferred();if(this.calendarCreateView!==false){a.resolve(this.calendarCreateView.clone(true,true));return a.promise()}var c=jQuery.progressIndicator();this.loadCalendarCreateView().then(function(d){c.hide();b.calendarCreateView=d;a.resolve(d.clone(true,true))},function(){c.hide()});return a.promise()},loadCalendarCreateView:function(){var a=jQuery.Deferred();var d=app.getModuleName();var c="index.php?module="+d+"&view=QuickCreateAjax";var b=Vtiger_Header_Js.getInstance();b.getQuickCreateForm(c,d).then(function(e){a.resolve(jQuery(e))},function(){a.reject()});return a.promise()},getCalendarView:function(){if(this.calendarView==false){this.calendarView=jQuery("#calendarview")}return this.calendarView},registerChangeView:function(){var a=this;a.getCalendarView().find("button.fc-button:not(.dropdown-toggle)").click(function(){a.loadCalendarData()})},registerEvents:function(){this.registerCalendar();this.loadCalendarData(true);this.registerChangeView();this.registerButtonSelectAll();this.registerRefreshEvent()}});