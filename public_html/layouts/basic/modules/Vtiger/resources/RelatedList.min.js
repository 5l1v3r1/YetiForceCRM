
jQuery.Class("Vtiger_RelatedList_Js",{instance:false,getInstance:function(g,e,b,f){if(Vtiger_RelatedList_Js.instance==false){var c=app.getModuleName()+"_RelatedList_Js";var d=Vtiger_RelatedList_Js;if(typeof window[c]!="undefined"){var a=new window[c]()}else{var a=new d()}Vtiger_RelatedList_Js.instance=a}else{var a=Vtiger_RelatedList_Js.instance}a.parentRecordId=g;a.parentModuleName=e;a.selectedRelatedTabElement=b;a.moduleName=f;a.relatedTabsContainer=b.closest("div.related");a.content=$("div.contents",a.relatedTabsContainer.closest("div.detailViewContainer"));return a},triggerMassAction:function(j,m){var b=Vtiger_List_Js.getInstance();var f=b.checkListRecordSelected();if(f!=true){var i=jQuery.progressIndicator();var k=b.readSelectedIds(true);var l=b.readExcludedIds(true);var c=b.getCurrentCvId();var e={viewname:c,selected_ids:k,excluded_ids:l};var h=Vtiger_List_Js.getInstance();if(h.getListSearchInstance()){var a=h.getListSearchInstance().getAlphabetSearchValue();e.search_params=JSON.stringify(h.getListSearchInstance().getListSearchParams());if((typeof a!="undefined")&&(a.length>0)){e.search_key=h.getListSearchInstance().getAlphabetSearchField();e.search_value=a;e.operator="s"}}var g={type:"POST",url:j,data:e};if(m==="sendByForm"){var d=$('<form method="POST" action="'+j+'">');if(typeof csrfMagicName!=="undefined"){d.append($("<input />",{name:csrfMagicName,value:csrfMagicToken}))}$.each(e,function(o,n){d.append($("<input />",{name:o,value:n}))});$("body").append(d);d.submit();i.progressIndicator({mode:"hide"})}else{AppConnector.request(g).then(function(n){i.progressIndicator({mode:"hide"});if(n&&n.result!==null){if(n.result.notify){Vtiger_Helper_Js.showMessage(n.result.notify)}if(n.result.reloadList){Vtiger_Detail_Js.reloadRelatedList()}if(n.result.procesStop){i.progressIndicator({mode:"hide"});return false}}},function(n,o){i.progressIndicator({mode:"hide"})})}}else{b.noRecordSelectedAlert()}}},{selectedRelatedTabElement:false,parentRecordId:false,parentModuleName:false,moduleName:false,relatedTabsContainer:false,content:false,listSearchInstance:false,detailViewContentHolder:false,setSelectedTabElement:function(a){this.selectedRelatedTabElement=a},getSelectedTabElement:function(){return this.selectedRelatedTabElement},getParentId:function(){return this.parentRecordId},getRelatedContainer:function(){return this.content},setRelatedContainer:function(a){this.content=a},getContentHolder:function(){if(this.detailViewContentHolder==false){this.detailViewContentHolder=$("div.details div.contents")}return this.detailViewContentHolder},getCurrentPageNum:function(){return $('input[name="currentPageNum"]',this.content).val()},setCurrentPageNumber:function(a){$('input[name="currentPageNum"]',this.content).val(a)},getOrderBy:function(){return $("#orderBy",this.content).val()},getSortOrder:function(){return $("#sortOrder",this.content).val()},getCompleteParams:function(){var b=this.getRelatedContainer();var d={view:"Detail",module:this.parentModuleName,record:this.getParentId(),relatedModule:this.moduleName,sortorder:this.getSortOrder(),orderby:this.getOrderBy(),page:this.getCurrentPageNum(),mode:"showRelatedList"};if(b.find(".pagination").length){d.totalCount=b.find(".pagination").data("totalCount")}if(b.find(".entityState").length){d.entityState=b.find(".entityState").val()}if(this.moduleName=="Calendar"){if(this.content.find(".switchBtn").is(":checked")){d.time="current"}else{d.time="history"}}if(this.listSearchInstance){var c=this.listSearchInstance.getAlphabetSearchValue();d.search_params=JSON.stringify(this.listSearchInstance.getListSearchParams())}if((typeof c!="undefined")&&(c.length>0)){d.search_key=this.listSearchInstance.getAlphabetSearchField();d.search_value=c;d.operator="s"}if(this.moduleName=="Calendar"){var a=b.find(".switchBtn");if(a.length){d.time=a.prop("checked")?"current":"history"}}return d},loadRelatedList:function(g){var b=jQuery.Deferred();var c=this;if(typeof c.moduleName=="undefined"||c.moduleName.length<=0){var e=Vtiger_Detail_Js.getInstance();e.loadWidgets();return b.promise()}var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var f=this.getCompleteParams();var a=c.relatedTabsContainer.find("li.active").data("reference");AppConnector.request($.extend(f,g)).then(function(h){var i=Vtiger_Detail_Js.getInstance();i.loadWidgets();if(a!="ProductsAndServices"){c.relatedTabsContainer.find("li").removeClass("active");c.selectedRelatedTabElement.addClass("active");c.content.html(h);d.progressIndicator({mode:"hide"});Vtiger_Helper_Js.showHorizontalTopScrollBar();$(".pageNumbers",c.content).tooltip();$("body").trigger(jQuery.Event("LoadRelatedRecordList.PostLoad"),{response:c.content,params:f,instance:c,moduleName:c.moduleName});c.registerPostLoadEvents();if(c.listSearchInstance){c.listSearchInstance.registerBasicEvents()}}b.resolve(h)},function(i,h){b.reject(i,h)});return b.promise()},triggerDisplayTypeEvent:function(){var a=app.cacheGet("widthType","narrowWidthType");if(a){var b=jQuery(".listViewEntriesTable").find("td,th");b.attr("class",a)}},showSelectRelationPopup:function(a){var b=jQuery.Deferred();var d=this;var e=Vtiger_Popup_Js.getInstance();var c=this.getPopupParams();$.extend(c,a);e.show(c,function(g){var f=JSON.parse(g);d.addRelations(f).then(function(j){var i=Vtiger_Detail_Js.getInstance();d.loadRelatedList().then(function(k){b.resolve(k);i.registerRelatedModulesRecordCount()});var h=d.getSelectedTabElement();if(h.data("link-key")=="LBL_RECORD_SUMMARY"){i.loadWidgets();i.registerRelatedModulesRecordCount()}})});return b.promise()},addRelations:function(b){var a=jQuery.Deferred();b=Object.keys(b);AppConnector.request({module:this.parentModuleName,action:"RelationAjax",mode:"addRelation",related_module:this.moduleName,src_record:this.parentRecordId,related_record_list:$.isArray(b)?JSON.stringify(b):b}).then(function(c){a.resolve(c)},function(d,c){a.reject(d,c)});return a.promise()},getPopupParams:function(){return{module:this.moduleName,src_module:this.parentModuleName,src_record:this.parentRecordId,multi_select:true}},deleteRelation:function(b){var a=jQuery.Deferred();AppConnector.request({module:this.parentModuleName,action:"RelationAjax",mode:"deleteRelation",related_module:this.moduleName,src_record:this.parentRecordId,related_record_list:JSON.stringify(b)}).then(function(c){a.resolve(c)},function(d,c){a.reject(d,c)});return a.promise()},sortHandler:function(c){var b=jQuery.Deferred();var a=c.data("nextsortorderval");if(typeof a==="undefined"){return}this.loadRelatedList({orderby:c.data("fieldname"),sortorder:a,}).then(function(d){b.resolve(d)},function(e,d){b.reject(e,d)});return b.promise()},nextPageHandler:function(){var c=jQuery.Deferred();var d=this;var e=jQuery("#pageLimit",this.content).val();var f=jQuery("#noOfEntries",this.content).val();if(f==e){var b=this.getCurrentPageNum();var a=parseInt(b)+1;this.loadRelatedList({page:a}).then(function(g){d.setCurrentPageNumber(a);c.resolve(g)},function(h,g){c.reject(h,g)})}return c.promise()},previousPageHandler:function(){var c=jQuery.Deferred();var d=this;var c=jQuery.Deferred();var a=this.getCurrentPageNum();if(a>1){var b=parseInt(a)-1;this.loadRelatedList({page:b}).then(function(e){d.setCurrentPageNumber(b);c.resolve(e)},function(f,e){c.reject(f,e)})}return c.promise()},selectPageHandler:function(a){var b=jQuery.Deferred();var c=this;var b=jQuery.Deferred();this.loadRelatedList({page:a,}).then(function(d){c.setCurrentPageNumber(a);b.resolve(d)},function(e,d){b.reject(e,d)});return b.promise()},pageJumpHandler:function(i){var h=jQuery.Deferred();var l=this;if(i.which==13){var d=jQuery(i.currentTarget);var b=Vtiger_WholeNumberGreaterThanZero_Validator_Js.invokeValidation(d);if(typeof b!="undefined"){d.validationEngine("showPrompt",b,"","topLeft",true);i.preventDefault()}else{d.validationEngine("hideAll");var c=parseInt(d.val());var g=parseInt(jQuery("#totalPageCount",l.content).text());if(c>g){var k=app.vtranslate("JS_PAGE_NOT_EXIST");d.validationEngine("showPrompt",k,"","topLeft",true)}var j=d.parent().find(".formError");if(j.length<1){var f=jQuery('input[name="currentPageNum"]',l.content).val();if(c==f){var m=app.vtranslate("JS_YOU_ARE_IN_PAGE_NUMBER")+" "+c;var a={text:m,type:"info"};Vtiger_Helper_Js.showMessage(a);i.preventDefault();return false}this.loadRelatedList({page:c}).then(function(e){l.setCurrentPageNumber(c);h.resolve(e)},function(n,e){h.reject(n,e)})}else{i.preventDefault()}}}return h.promise()},addRelatedRecord:function(d,i){var h=jQuery.Deferred();var l=this;var b=this.moduleName;var r=this.getParentId();var o=this.parentModuleName;var f={};var e={};var s=d.data("name");var m=d.data("url");e[s]=r;var k=new Array("view","module","mode","action");var n=function(y){var v,w,A;if(typeof m!="undefined"&&m.indexOf("?")!==-1){var x=m.split("?");var B=x[1];var u=B.split("&");for(v=0;v<u.length;v++){w=u[v];A=w.split("=");if(A[0]=="mode"&&A[1]=="Calendar"){y.find('a[data-tab-name="Task"]').trigger("click")}}}jQuery('<input type="hidden" name="sourceModule" value="'+o+'" />').appendTo(y);jQuery('<input type="hidden" name="sourceRecord" value="'+r+'" />').appendTo(y);jQuery('<input type="hidden" name="relationOperation" value="true" />').appendTo(y);if(typeof s!="undefined"){var z=y.find('[name="'+s+'"]');if(z.length==0){jQuery('<input type="hidden" name="'+s+'" value="'+r+'" />').appendTo(y)}}for(v=0;v<u.length;v++){w=u[v];A=w.split("=");if(jQuery.inArray(A[0],k)=="-1"&&y.find('[name="'+A[0]+'"]').length==0){jQuery('<input type="hidden" name="'+A[0]+'" value="'+A[1]+'" />').appendTo(y)}}if(typeof i!=="undefined"){i()}};var t=function(u){l.loadRelatedList().then(function(v){h.resolve(v)})};if(typeof m!="undefined"&&m.indexOf("?")!==-1){var q=m.split("?");var g=q[1];var p=g.split("&");for(var j=0;j<p.length;j++){var a=p[j];var c=a.split("=");if(jQuery.inArray(c[0],k)=="-1"){e[c[0]]=c[1]}}}f.data=e;f.callbackFunction=t;f.callbackPostShown=n;f.noCache=true;Vtiger_Header_Js.getInstance().quickCreateModule(b,f);return h.promise()},getRelatedPageCount:function(){var b=jQuery.Deferred();var c=this.content.find("#totalPageCount");var d=this.content.find("#totalCount");var a=c.text();if(a==""){c.progressIndicator({});AppConnector.request({module:this.parentModuleName,action:"RelationAjax",mode:"getRelatedListPageCount",record:this.getParentId(),relatedModule:this.moduleName,}).then(function(g){var f=g.result["page"];var e=g.result["numberOfRecords"];d.val(e);c.text(f);c.progressIndicator({mode:"hide"});b.resolve()},function(e,f){b.reject(false)})}else{b.resolve()}return b.promise()},favoritesRelation:function(c,b){var a=jQuery.Deferred();if(c){AppConnector.request({module:this.parentModuleName,action:"RelationAjax",mode:"updateFavoriteForRecord",record:this.getParentId(),relcrmid:c,relatedModule:this.moduleName,actionMode:b?"delete":"add",}).then(function(d){if(d.result){a.resolve(true)}},function(d,e){a.reject(false)})}else{a.reject(false)}return a.promise()},registerUnreviewedCountEvent:function(){var b=[];var c=this.content;var a=c.find(".unreviewed").length;c.find("tr.listViewEntries").each(function(){var d=jQuery(this).data("id");if(d){b.push(d)}});if(!b||a<1){return}AppConnector.request({action:"ChangesReviewedOn",mode:"getUnreviewed",module:"ModTracker",sourceModule:this.moduleName,recordsId:b}).then(function(d){var e=d.result;$.each(e,function(g,f){if(f.a>0){c.find('tr[data-id="'+g+'"] .unreviewed .badge.all').text(f.a)}if(f.m>0){c.find('tr[data-id="'+g+'"] .unreviewed .badge.mail').text(f.m)}})})},registerChangeEntityStateEvent:function(){var a=this;var b=this.content;b.on("click",".dropdownEntityState a",function(d){var c=$(this);b.find(".entityState").val(c.data("value"));b.find(".pagination").data("totalCount",0);b.find(".dropdownEntityState button").find("span").attr("class",c.find("span").attr("class"));a.loadRelatedList({page:1})})},registerRowsEvent:function(){this.content.on("click",".listViewEntries",function(b){var a=$(b.target);if(a.is("td")){document.location.href=a.closest("tr").data("recordurl")}});this.content.on("click",".showInventoryRow",function(b){var a=$(this);var c=a.closest("tr");var d=c.next();if(d.hasClass("listViewInventoryEntries")){d.toggleClass("hide")}})},registerSummationEvent:function(){var a=this;this.content.on("click",".listViewSummation button",function(){var d=$(this);var b=d.closest("td").find(".calculateValue");var e=a.getCompleteParams();e.action="RelationAjax";e.mode="calculate";e.fieldName=d.data("field");e.calculateType=d.data("operator");delete e.view;var c=$.progressIndicator({message:app.vtranslate("JS_CALCULATING_IN_PROGRESS"),position:"html",blockInfo:{enabled:true}});app.hidePopover(d);AppConnector.request(e).then(function(f){if(f.success){b.html(f.result)}else{b.html("")}c.progressIndicator({mode:"hide"})});c.progressIndicator({mode:"hide"})})},registerPaginationEvents:function(){var a=this;var b=this.content;this.content.on("click","#relatedViewNextPageButton",function(c){if($(this).hasClass("disabled")){return}a.nextPageHandler()});this.content.on("click","#relatedViewPreviousPageButton",function(){a.previousPageHandler()});this.content.on("click","#relatedListPageJump",function(c){a.getRelatedPageCount()});this.content.on("click","#relatedListPageJumpDropDown > li",function(c){c.stopImmediatePropagation()}).on("keypress","#pageToJump",function(c){a.pageJumpHandler(c)});this.content.on("click",".pageNumber",function(){if($(this).hasClass("disabled")){return false}a.selectPageHandler($(this).data("id"))});this.content.on("click","#totalCountBtn",function(){app.hidePopover($(this));var c={module:a.parentModuleName,view:"Pagination",mode:"getRelationPagination",record:a.getParentId(),relatedModule:a.moduleName,noOfEntries:$("#noOfEntries",b).val(),page:b.find('[name="currentPageNum"]').val(),};if(b.find(".entityState").length){c.entityState=b.find(".entityState").val()}AppConnector.request(c).then(function(d){b.find(".paginationDiv").html(d)})})},registerListEvents:function(){var a=this;this.content.on("click",".relatedListHeaderValues",function(b){a.sortHandler($(this))});this.content.on("click","a.favorites",function(d){var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var b=$(this);var f=b.closest("tr");a.favoritesRelation(f.data("id"),b.data("state")).then(function(e){if(e){var g=b.data("state")?0:1;b.data("state",g);b.find(".glyphicon").each(function(){if(jQuery(this).hasClass("hide")){jQuery(this).removeClass("hide")}else{jQuery(this).addClass("hide")}});c.progressIndicator({mode:"hide"});var h=app.vtranslate("JS_REMOVED_FROM_FAVORITES");if(g){h=app.vtranslate("JS_ADDED_TO_FAVORITES")}Vtiger_Helper_Js.showPnotify({text:h,type:"success",animation:"show"})}})});this.content.on("click",'[name="addButton"]',function(c){var b=$(this);if(b.hasClass("quickCreateSupported")!=true){window.location.href=b.data("url");return}a.addRelatedRecord(b)});this.content.on("click","button.selectRelation",function(c){var b=$(this).data("rf");var d={};if(b&&Object.keys(b).length>0){d={search_key:b.key,search_value:b.name}}a.showSelectRelationPopup(d)});this.content.on("click","a.relationDelete",function(c){c.stopImmediatePropagation();var b=$(this);Vtiger_Helper_Js.showConfirmationBox({message:app.vtranslate("JS_DELETE_CONFIRMATION")}).then(function(d){var f=b.closest("tr");a.deleteRelation([f.data("id")]).then(function(e){if(e.result){var i=b.closest(".widgetContentBlock");var h=Vtiger_Detail_Js.getInstance();if(i.length){h.loadWidget(i);var g=a.getContentHolder().find("[data-type='Updates']");if(g.length>0){h.loadWidget(g)}}else{a.loadRelatedList()}h.registerRelatedModulesRecordCount()}else{Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_CANNOT_REMOVE_RELATION"))}})})});this.content.off("switchChange.bootstrapSwitch").on("switchChange.bootstrapSwitch",".switchBtn",function(c,b){a.loadRelatedList()})},registerPostLoadEvents:function(){app.showBtnSwitch(this.content.find(".switchBtn"));app.showPopoverElementView(this.content.find(".popoverTooltip"));this.listSearchInstance=YetiForce_ListSearch_Js.getInstance(this.content,false,this)},registerRelatedEvents:function(){this.registerUnreviewedCountEvent();this.registerChangeEntityStateEvent();this.registerRowsEvent();this.registerPaginationEvents();this.registerListEvents();this.registerPostLoadEvents();this.registerSummationEvent();Vtiger_Helper_Js.showHorizontalTopScrollBar()},});